# Production Override for Self-Hosted Opik + LibreChat
# Use this for production deployments with proper resource limits and security

version: '3.8'

services:
  # ===========================================
  # Opik Services - Production Configuration
  # ===========================================

  opik-mysql:
    environment:
      # Use strong passwords from .env
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=1000
      - --innodb-buffer-pool-size=2G
      - --innodb-log-file-size=512M
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    volumes:
      - opik-mysql-data:/var/lib/mysql
      - ./backups/mysql:/backups

  opik-redis:
    command:
      - redis-server
      - --maxmemory 2gb
      - --maxmemory-policy allkeys-lru
      - --appendonly yes
      - --requirepass ${REDIS_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  opik-clickhouse:
    environment:
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
    command:
      - --max_server_memory_usage_to_ram_ratio=0.8
      - --max_concurrent_queries=200
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    volumes:
      - opik-clickhouse-data:/var/lib/clickhouse
      - ./backups/clickhouse:/backups
      - ./opik/clickhouse-config-prod.xml:/etc/clickhouse-server/config.d/custom.xml:ro

  opik-minio:
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  opik-backend:
    environment:
      # Database with strong passwords
      DB_PASSWORD: ${MYSQL_PASSWORD}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}

      # Stronger JWT secret for production
      JWT_SECRET: ${OPIK_JWT_SECRET}

      # Production settings
      NODE_ENV: production
      LOG_LEVEL: info

      # CORS settings (adjust for your domain)
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3080,https://yourdomain.com}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    # Uncomment for HTTPS in production
    # volumes:
    #   - ./ssl/opik-backend:/ssl:ro

  opik-frontend:
    environment:
      # Point to production backend
      VITE_API_URL: ${OPIK_FRONTEND_API_URL:-http://localhost:8080}
      VITE_PYTHON_API_URL: ${OPIK_PYTHON_API_URL:-http://localhost:8000}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # ===========================================
  # LibreChat Services - Production Configuration
  # ===========================================

  librechat-mongodb:
    environment:
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    command:
      - --auth
      - --wiredTigerCacheSizeGB=2
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    volumes:
      - librechat-mongodb-data:/data/db
      - ./backups/mongodb:/backups

  librechat-backend:
    environment:
      NODE_ENV: production

      # Stronger secrets
      CREDS_KEY: ${CREDS_KEY}
      CREDS_IV: ${CREDS_IV}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      JWT_REFRESH_SECRET: ${LIBRECHAT_JWT_REFRESH_SECRET}

      # Rate limiting
      LIMIT_CONCURRENT_MESSAGES: 1
      LIMIT_MESSAGE_IP: 40
      LIMIT_MESSAGE_USER: 40

      # Session security
      SESSION_EXPIRY: 900000  # 15 minutes
      REFRESH_TOKEN_EXPIRY: 604800000  # 7 days

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    # Uncomment for HTTPS
    # volumes:
    #   - ./ssl/librechat:/ssl:ro

  # ===========================================
  # Nginx Reverse Proxy with SSL (Optional)
  # ===========================================

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    profiles: ["production"]
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/htpasswd:/etc/nginx/htpasswd:ro
    networks:
      - opik-network
      - librechat-network
    depends_on:
      - librechat-backend
      - opik-backend
      - opik-frontend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

volumes:
  opik-mysql-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/opik-mysql

  opik-redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/opik-redis

  opik-clickhouse-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/opik-clickhouse

  librechat-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/librechat-mongodb
